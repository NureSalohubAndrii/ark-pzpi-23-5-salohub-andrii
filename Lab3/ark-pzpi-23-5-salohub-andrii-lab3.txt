МІНІСТЕРСТВО ОСВІТИ І НАУКИ УКРАЇНИ
ХАРКІВСЬКИЙ НАЦІОНАЛЬНИЙ УНІВЕРСИТЕТ РАДІОЕЛЕКТРОНІКИ


КАФЕДРА ПРОГРАМНОЇ ІНЖЕНЕРІЇ




Звіт
з лабораторної роботи № 3 з дисципліни
Аналіз та рефакторинг коду





Виконала:                                                                         Перевірив:
ст. гр. ПЗПІ-23-5                        				ст. викладач кафедри ПІ
Салогуб Андрій Сергійович 				          Сокорчук Ігор Петрович









Харків 2025


1 ІСТОРІЯ ЗМІН

№
Версія звіту
Опис змін та виправлень
1
0.1
Створено розділ “Історія змін”


      


2 ЗАВДАННЯ

   Завдання:
1. Розробити бізнес логіку серверної частини програмної системи.
2. Розробити функції адміністрування серверної частини програмної системи.
3. Створити програмну реалізацію бізнес логіки та функцій адміністрування серверної частини.
4. Перевірити роботу серверної частини системи.
5. Завантажити або оновити (при потребі) створений програмний код у GitHub репозиторій для лабораторних робіт у гілку репозиторію main.
6. Створити відеозапис демонстрації описаної у розділі 3.1 Vision & Scope функціональності серверної частини та завантажити цей відеозапис у свій канал на YouTube для облікового запису в домені @nure.ua.  При завантаженні відеозапису потрібно обовʼязково встановити у налаштуваннях для цього відео українську мову як мову відео та мову субтитрів до відео.
7. Створити хронологічний опис (хвилина:секунда) демонстрації та додати цей опис до опису відео.
8. Створити звіт до лабораторної роботи.
9. Експортувати створений звіт у формат PDF та завантажити його на платформу dl.nure.ua.
10. Експортувати увесь створений звіт у простий текстовий файл з кодуванням UTF-8 та записати цей файл у GitHub репозиторій для лабораторних робіт з вказаним у цих методичних вказівках іменем файла та директорії.



3 ОПИС ВИКОНАНОЇ РОБОТИ

     У межах лабораторної роботи було реалізовано модуль адміністрування серверної частини програмної системи. Даний модуль призначений для керування користувачами, контролю стану бази даних, виконання операцій резервного копіювання та відновлення, а також для перевірки та верифікації автомобілів у системі. Доступ до адміністративного функціоналу обмежений та можливий лише для автентифікованих користувачів з роллю адміністратора.
     Було реалізовано функціонал блокування та розблокування користувачів. Це дозволяє адміністратору оперативно реагувати на порушення правил використання системи.
     Основні можливості:
• блокування користувача за ідентифікатором;
• розблокування користувача;
• перевірка існування користувача перед виконанням операції.
     Фрагмент коду блокування користувача (рядки 1–11) (діаграма діяльності наведена на рис. 1):
1 async blockUser(userId: string, reason: string) {
2 const [user] = await db
3 .update(users)
4 .set({ isBlocked: true })
5 .where(eq(users.id, userId))
6 .returning();
8 if (!user) throw new AppError(404, 'User not found');
10 return { userId: user.id, status: 'blocked', reason };
11 }

     У цьому фрагменті (рядки 2–6) виконується оновлення запису користувача в базі даних, а у разі відсутності користувача (рядок 8) повертається відповідна помилка.
     Адміністративний модуль містить набір інструментів для аналізу та обслуговування бази даних:
• створення резервних копій (діаграма діяльності наведена на рис. 2);
• перегляд списку наявних резервних;
• відновлення бази даних з резервної копії  (діаграма діяльності наведена на рис. 3);
• видалення резервних копій;
• аналіз розміру таблиць;
• оптимізація бази даних (VACUUM ANALYZE).
     Резервне копіювання реалізовано шляхом виклику утиліти pg_dump через системну команду. Файли резервних копій зберігаються на сервері у відповідній директорії.
     Фрагмент коду створення backup (рядки 15–33):
15 const command = `pg_dump -h ${host} -p ${port} -U ${user} \
16 --no-owner --no-acl -F p -f "${fullPath}" ${database}`;
17
18 await execPromise(command, {
19 env: {
20 ...process.env,
21 PGPASSWORD: password,
22 },
23 });

     У наведеному фрагменті (рядки 15–16) формується команда резервного копіювання, а у рядках 18–23 забезпечується передача змінних середовища, зокрема пароля до бази даних.
     Для аналізу використовується SQL-запит до системних таблиць PostgreSQL, що дозволяє визначити розмір кожної таблиці та загальний обсяг бази даних. Оптимізація реалізована через виконання команди VACUUM ANALYZE.
     Важливою частиною адміністративної логіки є перевірка та верифікація автомобілів, зареєстрованих у системі. Адміністратор може:
• переглядати список автомобілів, що очікують на перевірку;
• підтверджувати або скасовувати верифікацію (діаграма діяльності наведена на рис. 4);
• виконувати масову верифікацію;
• переглядати статистику перевірок.
     Фрагмент коду верифікації автомобіля (рядки 1–11):
1 const [updatedCar] = await db
2 .update(cars)
3 .set({
4 isVerified: verificationData.isVerified,
5 verifiedAt: verificationData.isVerified ? new Date() : null,
6 verifiedBy: verificationData.isVerified ? adminId : null,
7 verificationNotes: verificationData.verificationNotes || null,
8 updatedAt: new Date(),
9 })
10 .where(eq(cars.id, carId))
11 .returning();

     У цьому фрагменті (рядки 1–11) відбувається оновлення статусу автомобіля та збереження інформації про адміністратора, який виконав перевірку. Додатково кожна дія адміністратора фіксується у журналі подій, що забезпечує аудит та простежуваність змін.
     Для моніторингу стану системи реалізовано функціонал перегляду статистики верифікацій та нещодавньої активності користувачів. Адміністратор може отримати зведену інформацію про:
• кількість зареєстрованих користувачів;
• кількість перевірок транспортних засобів;
• події, зафіксовані в системі за певний період часу.

     Також у межах лабораторної роботи було реалізовано бізнес-логіку серверної частини програмної системи. Бізнес-логіка реалізована у вигляді окремого сервісу аналітики.
     Для забезпечення достовірності даних у системі реалізовано бізнес-логіку автоматичного виявлення аномалій пробігу автомобіля (діаграма діяльності для цього процесу наведена на рис. 5). Аналіз базується на статистичному методі Z-score, що дозволяє знаходити різкі відхилення від середнього значення.
     Фрагмент коду обчислення статистичних показників (рядки 1–5):
1 const mean = differences.reduce((a, b) => a + b, 0) / differences.length;
2 const variance =
3 differences.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) /
4 differences.length;
5 const stdDev = Math.sqrt(variance);

     У цьому фрагменті (рядки 1–5) обчислюються середнє значення та стандартне відхилення зміни пробігу, що є основою для подальшого визначення аномальних значень.
     У разі виявлення відхилень система класифікує їх за типом (зменшення пробігу або аномально високий приріст) та рівнем критичності, що може бути використано для подальших адміністративних рішень.
	Також у системі реалізовано бізнес-логіку прогнозування майбутнього пробігу автомобіля (діаграма діяльності наведена на рис. 6). Прогноз виконується за допомогою лінійної регресії на основі історичних даних.
     Фрагмент коду побудови регресійної моделі (рядки 1–4):
1 const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
2 const intercept = (sumY - slope * sumX) / n;
4 const predictedMileage = slope * futureX + intercept;

     У наведеному фрагменті (рядки 1–4) обчислюються параметри регресійної моделі та прогнозне значення пробігу. Додатково розраховується коефіцієнт детермінації, який використовується для оцінки достовірності прогнозу.
     Аналітичний модуль забезпечує формування зведеної статистики роботи всієї системи. До глобальної аналітики входять:
• кількість користувачів, автомобілів, перевірок та подій;
• розподіл автомобілів за рівнем ризику;
• статистика типів подій та перевірок;
• середній показник ризику по системі.
     Даний функціонал дозволяє оцінити загальний стан системи та виявити потенційні проблемні зони.
     Окремим елементом бізнес-логіки є аналіз поведінки користувачів. Реалізований алгоритм аналізує:
• активність виконання перевірок;
• динаміку володіння автомобілями;
• участь користувача у створенні подій.
     Результатом є узагальнений профіль активності користувача, який може бути використаний для рейтингових або безпекових механізмів.
     Для підвищення рівня безпеки реалізовано бізнес-логіку формування звіту про автомобілі з високим ризиком. У звіт включаються транспортні засоби з показником ризику вище заданого порогу, відсортовані за спаданням.
     Для кожного автомобіля формується рекомендація щодо подальших дій (обовʼязкова перевірка або негайне блокування), що дозволяє використовувати даний модуль як інструмент підтримки управлінських рішень.




4 ВИСНОВКИ

     У межах лабораторної роботи було успішно реалізовано бізнес-логіку та функції адміністрування серверної частини програмної системи, що забезпечують ефективне керування користувачами, базою даних, верифікацією автомобілів та аналітикою даних. Розроблений адміністративний модуль дозволяє блокувати/розблоковувати користувачів, створювати резервні копії, оптимізувати базу даних та виконувати перевірки транспортних засобів з фіксацією подій у журналі, що підвищує безпеку та простежуваність системи. Бізнес-логіка, побудована на статистичних методах (Z-score для виявлення аномалій) та моделях прогнозування (лінійна регресія), забезпечує автоматичний аналіз пробігу автомобілів, оцінку ризиків, профілювання користувачів та формування звітів, що сприяє оперативному прийняттю рішень.




ДОДАТОК А
Відеозапис

Відеозапис презентації результатів лабораторної роботи: https://youtu.be/tqiU3-6fs1Q

Хронологічний опис відеозапису:
00:00 - Представлення
00:06 - Завдання, яке потрібно було виконати
00:21 - Структури реалізації
00:49 - Специфікація розробленого API
01:35 - Верефікація автомобілю адміністратором
02:27 - Функціонал адміністування бази даних
04:25 - Визначення аномалій з пробігом
06:15 - Передбачення майбутнього пробігу
07:28 - Загальна аналітика по системі
07:50 - Аналітика поведінки користувача



ДОДАТОК Б
Графічні матеріали


Рисунок 1 — UML діаграма діяльності для процесу блокування користувача


Рисунок 2 — UML діаграма діяльності для процесу створення резервного копіювання бази даних


Рисунок 3 — UML діаграма діяльності для процесу відновлення бази даних з резервної копії


Рисунок 4 — UML діаграма діяльності для процесу верефікації автомобіля

Рисунок 5 — UML діаграма діяльності для процесу виявлення аномалій пробігу автомобіля


Рисунок 6 — UML діаграма діяльності для процесу прогнозування майбутнього пробігу автомобіля

Рисунок 6 — UML діаграма взаємодії серверної частини під час виявлення аномалій пробігу


Рисунок 7 — UML діаграма взаємодії серверної частини для сценарію створення резервної копії бази даних


Рисунок 8 — UML діаграма взаємодії серверної частини для сценарію виявлення аномалій пробігу







Рисунок 9 — Cпецифікація розробленого API для адміну



Рисунок 2 — Cпецифікація розробленого API для аналітики





ДОДАТОК В
Специфікацію API

Специфікація API адміну:
/**
 * @swagger
 * tags:
 *  - name: Admin
 *    description: Administrative operations including user management and database maintenance
 */

/**
 * @swagger
 * /api/admin/users/{userId}/block:
 *   patch:
 *     summary: Block a user account
 *     description: Permanently blocks a user account, preventing them from accessing the system
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: userId
 *         required: true
 *         schema:
 *           type: string
 *         description: The ID of the user to block
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               reason:
 *                 type: string
 *                 description: Reason for blocking the user (optional but recommended)
 *             required:
 *               - reason
 *     responses:
 *       200:
 *         description: User successfully blocked
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     userId:
 *                       type: string
 *                     status:
 *                       type: string
 *                       enum: [blocked]
 *                     reason:
 *                       type: string
 *       404:
 *         description: User not found
 */

/**
 * @swagger
 * /api/admin/users/{userId}/unblock:
 *   patch:
 *     summary: Unblock a user account
 *     description: Restores access to a previously blocked user account
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: userId
 *         required: true
 *         schema:
 *           type: string
 *         description: The ID of the user to unblock
 *     responses:
 *       200:
 *         description: User successfully unblocked
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     userId:
 *                       type: string
 *                     status:
 *                       type: string
 *                       enum: [active]
 *                     message:
 *                       type: string
 *       404:
 *         description: User not found
 */

/**
 * @swagger
 * /api/admin/db/backup:
 *   post:
 *     summary: Create a new database backup
 *     description: Creates a complete database backup using pg_dump and stores it in the local backups directory
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Database backup created successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     filename:
 *                       type: string
 *                     path:
 *                       type: string
 *                     size:
 *                       type: string
 *                     storageType:
 *                       type: string
 *                     createdAt:
 *                       type: string
 *                       format: date-time
 *       500:
 *         description: Backup creation failed (requires postgresql-client to be installed)
 */

/**
 * @swagger
 * /api/admin/db/analysis:
 *   get:
 *     summary: Get database storage analysis
 *     description: Returns detailed analysis of database table sizes and their relative proportions
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Database storage analysis
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     stats:
 *                       type: array
 *                       items:
 *                         type: object
 *                         properties:
 *                           tableName:
 *                             type: string
 *                           rawBytes:
 *                             type: number
 *                           formattedSize:
 *                             type: string
 *                           percentage:
 *                             type: string
 *                     totalSize:
 *                       type: string
 */

/**
 * @swagger
 * /api/admin/db/optimize:
 *   post:
 *     summary: Perform database maintenance
 *     description: Executes VACUUM ANALYZE to optimize database storage and update query planner statistics
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Database maintenance completed successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     status:
 *                       type: string
 *                     operation:
 *                       type: string
 *                     message:
 *                       type: string
 *                     timestamp:
 *                       type: string
 *                       format: date-time
 */

/**
 * @swagger
 * /api/admin/db/backups:
 *   get:
 *     summary: Get list of available database backups
 *     description: Returns a list of all available backup files in the backup directory, sorted by creation time
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: List of available backups
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: array
 *                   items:
 *                     type: object
 *                     properties:
 *                       filename:
 *                         type: string
 *                       size:
 *                         type: string
 *                       createdAt:
 *                         type: string
 *                         format: date-time
 */

/**
 * @swagger
 * /api/admin/db/restore:
 *   post:
 *     summary: Restore database from backup
 *     description: Restores the database from a specified backup file. This operation completely replaces the current database contents
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - filename
 *             properties:
 *               filename:
 *                 type: string
 *                 description: Name of the backup file to restore from
 *     responses:
 *       200:
 *         description: Database successfully restored
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     message:
 *                       type: string
 *                     restoredFrom:
 *                       type: string
 *                     durationSeconds:
 *                       type: number
 *                     timestamp:
 *                       type: string
 *                       format: date-time
 *       400:
 *         description: Filename is required
 *       404:
 *         description: Backup file not found
 *       500:
 *         description: Restore process failed
 */

/**
 * @swagger
 * /api/admin/db/backups:
 *   delete:
 *     summary: Delete a database backup file
 *     description: Permanently removes a specific backup file from the server's backup directory
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - filename
 *             properties:
 *               filename:
 *                 type: string
 *                 description: Exact name of the backup file to delete (e.g., backup-2025-12-13T10-30-00Z.sql)
 *     responses:
 *       200:
 *         description: Backup file deleted successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     success:
 *                       type: boolean
 *                     filename:
 *                       type: string
 *                     message:
 *                       type: string
 *                     deletedAt:
 *                       type: string
 *                       format: date-time
 *                 message:
 *                   type: string
 *       400:
 *         description: Filename is missing or invalid
 *       404:
 *         description: Backup file not found
 *       500:
 *         description: Failed to delete the backup file
 */

/**
 * @swagger
 * /api/admin/cars/awaiting-verification:
 *   get:
 *     summary: Get list of cars awaiting verification
 *     description: Returns a list of unverified cars (isVerified = false or NULL), including owner info and tampering incidents. Sorted by creation date (newest first).
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 50
 *         description: Maximum number of cars to return
 *     responses:
 *       200:
 *         description: List of cars awaiting verification
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: array
 *                   items:
 *                     type: object
 *                     properties:
 *                       id:
 *                         type: string
 *                       vin:
 *                         type: string
 *                       make:
 *                         type: string
 *                       model:
 *                         type: string
 *                       year:
 *                         type: integer
 *                       riskScore:
 *                         type: number
 *                       currentMileage:
 *                         type: number
 *                       status:
 *                         type: string
 *                       createdAt:
 *                         type: string
 *                         format: date-time
 *                       currentOwner:
 *                         type: object
 *                         nullable: true
 *                         properties:
 *                           id:
 *                             type: string
 *                           email:
 *                             type: string
 *                           firstName:
 *                             type: string
 *                           lastName:
 *                             type: string
 *                       tamperingIncidents:
 *                         type: integer
 *                       priority:
 *                         type: string
 *                         enum: [high, medium, low]
 */

/**
 * @swagger
 * /api/admin/cars/{carId}/verify:
 *   patch:
 *     summary: Verify or revoke verification of a car
 *     description: Admin manually verifies or revokes verification of a car. Creates corresponding event in carEvents table.
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: carId
 *         required: true
 *         schema:
 *           type: string
 *         description: ID of the car
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - isVerified
 *             properties:
 *               isVerified:
 *                 type: boolean
 *                 description: true to verify, false to revoke
 *               verificationNotes:
 *                 type: string
 *                 nullable: true
 *                 description: Optional admin notes
 *     responses:
 *       200:
 *         description: Car verification status updated
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     carId:
 *                       type: string
 *                     vin:
 *                       type: string
 *                     isVerified:
 *                       type: boolean
 *                     verifiedAt:
 *                       type: string
 *                       format: date-time
 *                       nullable: true
 *                     verificationNotes:
 *                       type: string
 *                       nullable: true
 *                     message:
 *                       type: string
 *       404:
 *         description: Car not found
 */

/**
 * @swagger
 * /api/admin/verification-stats:
 *   get:
 *     summary: Get verification statistics
 *     description: Returns overall statistics on car verification status and recent admin verification activity.
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Verification statistics
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     totals:
 *                       type: object
 *                       properties:
 *                         allCars:
 *                           type: integer
 *                         verified:
 *                           type: integer
 *                         pendingVerification:
 *                           type: integer
 *                         rejected:
 *                           type: integer
 *                     rates:
 *                       type: object
 *                       properties:
 *                         verificationRate:
 *                           type: string
 *                           example: "87.45%"
 *                         pendingRate:
 *                           type: string
 *                     recentActivity:
 *                       type: array
 *                       items:
 *                         type: object
 *                         properties:
 *                           carVin:
 *                             type: string
 *                           carInfo:
 *                             type: string
 *                           action:
 *                             type: string
 *                           date:
 *                             type: string
 *                             format: date-time
 */

/**
 * @swagger
 * /api/admin/recent-activity:
 *   get:
 *     summary: Get recent system activity
 *     description: Returns summary of recent user registrations, vehicle checks, and car events within the specified time window (default 60 minutes).
 *     tags: [Admin]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: limitMinutes
 *         schema:
 *           type: integer
 *           default: 60
 *         description: Time window in minutes
 *     responses:
 *       200:
 *         description: Recent activity summary
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     timeWindow:
 *                       type: string
 *                     summary:
 *                       type: object
 *                       properties:
 *                         newUsers:
 *                           type: integer
 *                         checksPerformed:
 *                           type: integer
 *                         eventsReported:
 *                           type: integer
 *                         totalActivity:
 *                           type: integer
 *                     details:
 *                       type: object
 *                       properties:
 *                         recentChecks:
 *                           type: array
 *                         recentEvents:
 *                           type: array
 *                         newUsers:
 *                           type: array
 */

Специфікація API аналітики:
/**
 * @swagger
 * tags:
 *   - name: Analytics
 *     description: Advanced analytics for car depreciation, mileage predictions, anomaly detection, and system reports
 */

/**
 * @swagger
 * /api/analytics/cars/{carId}/mileage-anomalies:
 *   get:
 *     summary: Detect mileage anomalies
 *     description: Uses statistical analysis (Z-score) to detect unusual mileage changes, including potential rollbacks or tampering
 *     tags: [Analytics]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: carId
 *         required: true
 *         schema:
 *           type: string
 *         description: Car ID
 *     responses:
 *       200:
 *         description: Mileage analysis completed
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     anomalies:
 *                       type: array
 *                       items:
 *                         type: object
 *                         properties:
 *                           eventIndex:
 *                             type: number
 *                           date:
 *                             type: string
 *                             format: date-time
 *                           mileageDifference:
 *                             type: number
 *                           daysElapsed:
 *                             type: number
 *                           dailyMileage:
 *                             type: number
 *                           zScore:
 *                             type: string
 *                           severity:
 *                             type: string
 *                             enum: [high, critical]
 *                           type:
 *                             type: string
 *                             enum: [rollback, unusually_high]
 *                           description:
 *                             type: string
 *                     statistics:
 *                       type: object
 *                       properties:
 *                         totalDataPoints:
 *                           type: number
 *                         meanMileageChange:
 *                           type: number
 *                         standardDeviation:
 *                           type: number
 *                         analysisMethod:
 *                           type: string
 *                     message:
 *                       type: string
 *                       nullable: true
 *       404:
 *         description: Car not found
 */

/**
 * @swagger
 * /api/analytics/cars/{carId}/predict-mileage:
 *   get:
 *     summary: Predict future mileage
 *     description: Uses linear regression to predict future mileage based on historical data
 *     tags: [Analytics]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: carId
 *         required: true
 *         schema:
 *           type: string
 *         description: Car ID
 *       - in: query
 *         name: daysAhead
 *         schema:
 *           type: integer
 *           default: 365
 *           minimum: 1
 *           maximum: 3650
 *         description: Number of days to predict ahead (max 10 years)
 *     responses:
 *       200:
 *         description: Mileage prediction calculated
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     currentMileage:
 *                       type: number
 *                     predictedMileage:
 *                       type: number
 *                     daysAhead:
 *                       type: number
 *                     dailyMileageRate:
 *                       type: number
 *                     annualMileageRate:
 *                       type: number
 *                     confidence:
 *                       type: object
 *                       properties:
 *                         rSquared:
 *                           type: string
 *                         interpretation:
 *                           type: string
 *                           enum: [High accuracy, Moderate accuracy, Low accuracy]
 *                     dataPointsUsed:
 *                       type: number
 *                     model:
 *                       type: object
 *                       properties:
 *                         equation:
 *                           type: string
 *                         slope:
 *                           type: string
 *                         intercept:
 *                           type: string
 *       400:
 *         description: Invalid parameters or insufficient data
 *       404:
 *         description: Car not found
 */

/**
 * @swagger
 * /api/analytics/system:
 *   get:
 *     summary: Get global system analytics
 *     description: Provides comprehensive system-wide statistics including users, cars, checks, events, and risk analysis
 *     tags: [Analytics]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: startDate
 *         schema:
 *           type: string
 *           format: date-time
 *         description: Filter start date (ISO 8601)
 *       - in: query
 *         name: endDate
 *         schema:
 *           type: string
 *           format: date-time
 *         description: Filter end date (ISO 8601)
 *     responses:
 *       200:
 *         description: System analytics retrieved
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     period:
 *                       type: object
 *                       properties:
 *                         startDate:
 *                           type: string
 *                         endDate:
 *                           type: string
 *                     totals:
 *                       type: object
 *                       properties:
 *                         users:
 *                           type: number
 *                         cars:
 *                           type: number
 *                         checks:
 *                           type: number
 *                         events:
 *                           type: number
 *                     riskAnalysis:
 *                       type: object
 *                       properties:
 *                         distribution:
 *                           type: array
 *                           items:
 *                             type: object
 *                             properties:
 *                               riskLevel:
 *                                 type: string
 *                               count:
 *                                 type: number
 *                         averageRiskScore:
 *                           type: number
 *                     eventBreakdown:
 *                       type: array
 *                       items:
 *                         type: object
 *                         properties:
 *                           eventType:
 *                             type: string
 *                           count:
 *                             type: number
 *                     checkTypeBreakdown:
 *                       type: array
 *                       items:
 *                         type: object
 *                         properties:
 *                           checkType:
 *                             type: string
 *                           count:
 *                             type: number
 *                     generatedAt:
 *                       type: string
 *                       format: date-time
 *       400:
 *         description: Invalid date parameters
 */

/**
 * @swagger
 * /api/analytics/users/{userId}/behavior:
 *   get:
 *     summary: Get user behavior analytics
 *     description: Analyzes user activity patterns including checks, ownership history, and contributions
 *     tags: [Analytics]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: userId
 *         required: true
 *         schema:
 *           type: string
 *         description: User ID
 *     responses:
 *       200:
 *         description: User behavior analytics retrieved
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     userId:
 *                       type: string
 *                     checkActivity:
 *                       type: object
 *                       properties:
 *                         totalChecks:
 *                           type: number
 *                         checksByMonth:
 *                           type: object
 *                           additionalProperties:
 *                             type: number
 *                         mostFrequentCheckType:
 *                           type: string
 *                           nullable: true
 *                     ownershipPatterns:
 *                       type: object
 *                       properties:
 *                         totalCarsOwned:
 *                           type: number
 *                         currentCars:
 *                           type: number
 *                         averageOwnershipDays:
 *                           type: number
 *                     contributionActivity:
 *                       type: object
 *                       properties:
 *                         eventsReported:
 *                           type: number
 *                         eventTypes:
 *                           type: string
 *                           nullable: true
 *       404:
 *         description: User not found
 */

/**
 * @swagger
 * /api/analytics/high-risk-cars:
 *   get:
 *     summary: Get high-risk cars report
 *     description: Returns a list of cars with risk scores >= 60, ordered by risk score
 *     tags: [Analytics]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 20
 *           minimum: 1
 *           maximum: 100
 *         description: Maximum number of results
 *     responses:
 *       200:
 *         description: High-risk cars retrieved
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: array
 *                   items:
 *                     type: object
 *                     properties:
 *                       vin:
 *                         type: string
 *                       make:
 *                         type: string
 *                       model:
 *                         type: string
 *                       year:
 *                         type: number
 *                       riskScore:
 *                         type: number
 *                       riskLevel:
 *                         type: string
 *                       status:
 *                         type: string
 *                       currentMileage:
 *                         type: number
 *                         nullable: true
 *                       hasCurrentOwner:
 *                         type: boolean
 *                       tamperingIncidents:
 *                         type: number
 *                       recommendation:
 *                         type: string
 *                         enum: [BLOCK IMMEDIATELY, REQUIRES VERIFICATION]
 *       400:
 *         description: Invalid limit parameter
 */


     



1



