МІНІСТЕРСТВО ОСВІТИ І НАУКИ УКРАЇНИ
ХАРКІВСЬКИЙ НАЦІОНАЛЬНИЙ УНІВЕРСИТЕТ РАДІОЕЛЕКТРОНІКИ


КАФЕДРА ПРОГРАМНОЇ ІНЖЕНЕРІЇ




Звіт
з лабораторної роботи № 2 з дисципліни
Аналіз та рефакторинг коду





Виконала:                                                                         Перевірив:
ст. гр. ПЗПІ-23-5                        				ст. викладач кафедри ПІ
Салогуб Андрій Сергійович 				          Сокорчук Ігор Петрович









Харків 2025


1 ІСТОРІЯ ЗМІН

№
Версія звіту
Опис змін та виправлень
1
0.1
Створено розділ “Історія змін”


      


2 ЗАВДАННЯ

   Завдання:
1. Розробити будову програмної системи.
2. Створити UML діаграму прецедентів для серверної частини системи.
3. Створити ER діаграму даних.
4. Розробити базу даних (БД) програмної системи.
5. Створити діаграму структури БД.
6. Розробити функції роботи з БД (ORM або CoRM тощо).
7. Розробити API (REST або GraphQL, gRPC тощо) для взаємодії серверної частини з клієнтами.
8. Створити специфікацію розробленого API.
9. Створити програмну реалізацію розробленого API та функцій роботи з БД.
10. Перевірити роботу створеного програмного коду серверної частини системи.
11. Завантажити або оновити (при потребі) створений програмний код у GitHub репозиторій для лабораторних робіт у гілку репозиторію main.
12. Створити відеозапис тривалістю 7-9 хвилин з демонстрацією перевірки (тестування) описаної у розділі 3.1 Vision & Scope функціональності серверної частини.
13. Завантажити створений відеозапис у свій канал для облікового запису студента в домені nure.ua на YouTube. При завантаженні відеозапису обовʼязково встановити у налаштуваннях для цього відео українську мову як мову відео та мову субтитрів до відео.
14. Створити хронологічний опис (хвилина:секунда) демонстрації та додати цей опис до опису відео на YouTube.
15. Створити звіт до лабораторної роботи.
16. Вказати у звіті посилання на створений відеозапис на YouTube
17. Експортувати створений звіт у формат PDF та завантажити його на платформу dl.nure.ua
18. Експортувати увесь створений звіт у текстовий файл з кодуванням UTF-8 та записати цей файл у GitHub репозиторій для лабораторних робіт.



3 ОПИС ВИКОНАНОЇ РОБОТИ

	Програмна система реалізована як серверна частина у вигляді REST API-додатку. Для розробки використано платформу Node.js, мову TypeScript та фреймворк Express.js. В якості бази даних було обрано PostgreSQL. Робота з даними здійснюється через сучасний Drizzle ORM. Аутентифікація користувачів виконана за допомогою JWT-токенів, які передаються в httpOnly-куках, а також передбачена обов’язкова верифікація електронної пошти. Система складається з кількох основних модулів: автентифікація та управління користувачами, робота з автомобілями, події та історія власності, генерація звітів по VIN, а також зарезервовані модулі для майбутньої інтеграції IoT-пристроїв. Уся взаємодія з клієнтськими додатками буде відбуватися через єдиний REST-інтерфейс.
     ER-діаграма розроблена з урахуванням нормалізації до третьої нормальної форми. Визначено основні сутності: користувач, автомобіль, зв’язкова таблиця історії власності, події пов’язані з автомобілем, перевірки по VIN, коди верифікації електронної пошти, а також зарезервовані сутності для телеметрії та алертів IoT-пристроїв. Ключові зв’язки між сутностями реалізовано через зовнішні ключі з каскадним видаленням. Один користувач може володіти багатьма автомобілями в різний час, один автомобіль може мати багато подій та багато записів про перевірки. Схема наведена на рисунку 1.
     Фізична модель бази даних відображає точні назви стовпців, їх типи даних, обмеження первинних та зовнішніх ключів, а також напрямки зв’язків між таблицями. На діаграмі чітко видно співвідношення один-до-багатьох та багато-до-багатьох, позначені nullable поля та значення за замовчуванням. Схема наведена на рисунку 2.
     Діаграма прецедентів відображає всіх основних акторів системи та їх взаємодію з серверною частиною. Серед акторів виділено неавторизованого користувача, авторизованого користувача та адміністратора. Неавторизований користувач має можливість реєструватися, входити в систему. Авторизований користувач може переглядати шукати автомобілі за VIN-кодом, додавати свої автомобілі, оновлювати їх дані, переглядати історію перевірок та отримувати звіти, він також має право редагувати інформацію лише про ті транспортні засоби, якими володіє на поточний момент. Адміністратор володіє можливістю блокування, розблокювання користувачів та перегляд усіх даних. Схема наведена на рисунку 3.
     Для роботи з базою даних обрано Drizzle ORM — сучасний типобезпечний ORM для TypeScript, який забезпечує повну інтеграцію типів бази даних у код. Усі операції створення, читання, оновлення та видалення винесено у відповідні сервіси. Завдяки Drizzle ORM запити пишуться майже як звичайний SQL, але з повним автодоповненням та перевіркою типів під час компіляції. Використовуються відношення для зручного отримання пов’язаних даних одним запитом. Для під’єднання до бази даних виконується код наведений нижче (рядки 1-17), cпочатку завантажуються змінні оточення з файлу .env (рядок 6). Потім створюється пул з'єднань до PostgreSQL за допомогою бібліотеки pg. У налаштуваннях пулу береться URL бази даних із змінної оточення (рядок 9).Далі об'єкт цього пулу передається в drizzle (рядок 15), і разом із імпортованою схемою бази даних створюється готовий об'єкт db. Цей db потім експортується і використовується в усьому проєкті для всіх запитів до бази даних. 
1  import { Pool } from 'pg';
2  import { drizzle } from 'drizzle-orm/node-postgres';
3  import dotenv from 'dotenv';
4  import * as schema from './schema';
6  dotenv.config();
8  const pool = new Pool({
9    connectionString: process.env.DATABASE_URL!,
10   ssl: {
11     rejectUnauthorized: false,
12   },
13 });
15 const db = drizzle(pool, { schema });
17 export { db };

     Прикладом створення таблиць в Drizzle ORM є код наведений нижче (рядки 1-18):
1   import { pgTable, uuid, varchar, boolean, timestamp } from 'drizzle-orm/pg-core';
3   export const users = pgTable('users', {
4     id: uuid('id').primaryKey().defaultRandom(),
5     email: varchar('email', { length: 255 }).notNull().unique(),
6     passwordHash: varchar('password_hash', { length: 255 }),
7     googleId: varchar('google_id', { length: 255 }).unique(),
8     firstName: varchar('first_name', { length: 100 }),
9     lastName: varchar('last_name', { length: 100 }),
10    role: varchar('role', { length: 20 }).notNull().default('user'),
11    isBlocked: boolean('is_blocked').notNull().default(false),
12    emailVerified: boolean('email_verified').notNull().default(false),
13    createdAt: timestamp('created_at').notNull().defaultNow(),
14    updatedAt: timestamp('updated_at')
15      .notNull()
16      .defaultNow()
17      .$onUpdate(() => new Date()),
18  });

     Реалізація розробленого API виконана у вигляді чистої, модульної архітектури з чітким поділом відповідальностей. Кожен модуль містить контролер, сервіс та маршрути. Код написаний з використанням строгої типізації, з повним захистом від null/undefined. Можна виділити деякі частини реалізованого кодую. Наприклад, перша — автоматична детекція скрутки пробігу при оновленні автомобіля (рядки 1-12). Коли власник намагається вказати менший пробіг, ніж був раніше — система не просто блокує операцію, а створює спеціальну подію типу mileage_tampering з високим рівнем небезпеки та автоматично підвищує ризик-скоринг автомобіля. Ось як це реалізовано:
1  if (data.currentMileage < oldMileage) {
2          await db.insert(carEvents).values({
3            carId,
4            eventType: 'mileage_tampering',
5            severity: 'high',
6            description: `Mileage rollback detected: ${oldMileage} → ${data.currentMileage} km`,
7            mileage: data.currentMileage,
8            eventDate: new Date(),
9            verifiedByIot: false,
10         });
11         await this.updateRiskScore(carId);
12 }

     Друга частина цього — автоматична генерація рекомендацій покупцеві на основі ризик-скору та критичних подій (рядки 1-32). Система сама аналізує дві найнебезпечніші речі — скрутку пробігу та високий ризик-скор (90+ балів) — і одразу видає чітку рекоментацію щодо того слід купляти чи ні. Навіть якщо скору трохи нижче, але є серйозні аварії — буде «високий ризик, обов’язкова діагностика».Це зрозуміла порада покупцеві: від зеленого «можна брати» до червоного «не розглядати моживість покупки цього автомобіля». 
1  private generateRecommendations(report) {
2    const recs: Array<{ severity: 'low' | 'medium' | 'high' | 'critical'; message: string }> = [];
3    const riskScore = report.car?.riskScore ?? 0;
4    const events = report.events ?? [];
5    const hasTampering = events.some((e) => e.eventType === 'mileage_tampering');
6    const hasAccidents = events.some(
7      (e) => e.eventType === 'accident' && e.severity === 'high'
8    );
10   if (riskScore >= 90 || hasTampering) {
11     recs.push({
12       severity: 'critical',
13       message: 'DO NOT BUY: Mileage tampering or critical risk detected',
14     });
15   } else if (riskScore >= 60 || hasAccidents) {
16     recs.push({
17       severity: 'high',
18       message: 'High risk. Professional inspection required',
19     });
20   } else if (riskScore >= 30) {
21     recs.push({
22       severity: 'medium',
23       message: 'Moderate risk. Check history carefully',
24     });
25   } else {
26     recs.push({
27       severity: 'low',
28       message: 'No major issues found. Vehicle appears clean',
29     });
30   }
31   return recs;
32 }

     Специфікація створена безпосередньо у коді за допомогою JSDoc-коментарів і автоматично генерується у інтерактивному Swagger UI (вигляд наведено на рисунку 4). Всі ендпоінти описані і мають приклади запитів, відповідей, схемами даних, можливими помилками та поясненнями. Визначено окремі компоненти схем для автомобіля, користувача, події, звіту та рекомендацій. Документація доступна за шляхом /api/docs і є повноцінним технічним довідником для фронтенду та майбутніх інтеграцій.









4 ВИСНОВКИ
  У ході виконання лабораторної роботи було успішно розроблено та реалізовано повноцінну серверну частину системи перевірки історії автомобілів за VIN-кодом. Створено масштабовану, типобезпечну архітектуру на базі Node.js, TypeScript та Express.js з використанням сучасного Drizzle ORM та PostgreSQL. Реалізована надійна система аутентифікації з JWT-токенами, httpOnly-куками та обов’язковою верифікацією електронної пошти. Розроблено детальну модель даних з нормалізацією до третьої нормальної форми, що забезпечує цілісність та ефективність зберігання інформації про автомобілі, власників, події та перевірки.
  Запроваджено інтелектуальні механізми захисту від шахрайства, зокрема автоматичне виявлення скручування пробігу з фіксацією події та підвищенням ризику, а також розумну систему оцінки ризиків з чіткими рекомендаціями покупцеві — від «можна купувати» до «категорично не рекомендується». Реалізовано гнучку модель монетизації через різні типи звітів (basic, extended, premium) з обмеженням доступу до конфіденційних даних.
  Створено чисте, добре документоване REST API зі Swagger-документацією, повною типізацією та чітким поділом відповідальностей між контролерами та сервісами. Увесь код розміщено у GitHub-репозиторії, протестовано, задокументовано у відео та звіті. 



ДОДАТОК А
Відеозапис

Відеозапис презентації результатів лабораторної роботи:
https://youtu.be/uhfKJk1UkQ8

Хронологічний опис відеозапису:
00:00 - Представлення
00:06 - Завдання, яке потрібно було виконати
00:12 - Пояснення схеми розробленої бази даних
00:45 - Як відбувається підключення до бази даних
01:09 - Приклад описаної схеми в Drizzle ORM
01:19 - Специфікація створеного API
01:55 - Наповнення бази даних до тестування API
02:07 - Тестування функціоналу реєстації та підтвердження пошти
03:00 - Тестування функціоналу входу
03:26 - Створення нового автомобілю
03:59 - Додавання події для автомобіля
04:33 - Отримання інформації про автомобіль за VIN-кодом
05:00 - Зміна пробігу автомобіля, автоматичне додавання події скручення та підвищення ризику
06:11 - Отримання всіх подій, які відбувались з автомобілем
06:34 - Дії з профілем користувача
07:09 - Отримання звіту про автомобіль


ДОДАТОК Б
Графічні матеріали


Рисунок 1 — ER-діаграма


Рисунок 2 — Діаграма структури бази даних

Рисунок 3 — UML діаграма прецедентів


Рисунок 4 — Cпецифікація розробленого API



ДОДАТОК В
Специфікацію API

Специфікація API авторизації:
/**
 * @swagger
 * tags:
 *   - name: Auth
 *     description: Authentication, registration, email verification, token management
 */

/**
 * @swagger
 * /api/auth/register:
 *   post:
 *     summary: Register a new user
 *     description: Creates a new user account and sends a 6-digit verification code to email
 *     tags: [Auth]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - password
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *                 example: user@example.com
 *               password:
 *                 type: string
 *                 minLength: 8
 *                 description: Minimum 8 characters
 *               firstName:
 *                 type: string
 *                 example: Andrii
 *               lastName:
 *                 type: string
 *                 example: Salohub
 *     responses:
 *       201:
 *         description: Registration successful. Verification code sent to email.
 *         content:
 *           application/json:
 *             example:
 *               success: true
 *               data:
 *                 message: "Registration successful. Please check your email to verify your account."
 *                 userId: "clz123abc456def789"
 *               message: "Registration successful. Please verify your email."
 *       400:
 *         description: Invalid email, weak password, or user already exists
 */

/**
 * @swagger
 * /api/auth/login:
 *   post:
 *     summary: Login with email and password
 *     description: Authenticates user and returns JWT token in httpOnly cookie + response
 *     tags: [Auth]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - password
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *               password:
 *                 type: string
 *                 format: password
 *     responses:
 *       200:
 *         description: Login successful
 *         headers:
 *           Set-Cookie:
 *             description: httpOnly JWT token (valid 7 days)
 *             schema:
 *               type: string
 *               example: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; Max-Age=604800
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     user:
 *                       $ref: '#/components/schemas/UserPublic'
 *                     token:
 *                       type: string
 *                       description: JWT token (also sent in cookie)
 *       401:
 *         description: Invalid credentials
 *       403:
 *         description: Email not verified or account blocked
 */

/**
 * @swagger
 * /api/auth/verify-email/{userId}:
 *   post:
 *     summary: Verify email with 6-digit code
 *     description: Completes registration by verifying the code sent to email
 *     tags: [Auth]
 *     parameters:
 *       - in: path
 *         name: userId
 *         required: true
 *         schema:
 *           type: string
 *         description: User ID returned during registration
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - code
 *             properties:
 *               code:
 *                 type: string
 *                 pattern: ^\d{6}$
 *                 example: "483920"
 *     responses:
 *       200:
 *         description: Email verified successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     message:
 *                       type: string
 *                     user:
 *                       $ref: '#/components/schemas/UserPublic'
 *                     token:
 *                       type: string
 *       400:
 *         description: Invalid or expired code
 *       404:
 *         description: User not found
 */

/**
 * @swagger
 * /api/auth/refresh:
 *   post:
 *     summary: Refresh JWT token
 *     description: Generates a new access token using valid current token
 *     tags: [Auth]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: New token issued
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     token:
 *                       type: string
 *       401:
 *         description: Invalid or expired token
 */

/**
 * @swagger
 * /api/auth/logout:
 *   post:
 *     summary: Logout user
 *     description: Clears the httpOnly cookie
 *     tags: [Auth]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Logged out successfully
 *         headers:
 *           Set-Cookie:
 *             description: Cookie cleared
 *             schema:
 *               type: string
 *               example: token=; HttpOnly; Max-Age=0
 */

/**
 * @swagger
 * /api/auth/me:
 *   get:
 *     summary: Get current authenticated user
 *     description: Returns profile of the logged-in user
 *     tags: [Auth]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Current user data
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   $ref: '#/components/schemas/UserPublic'
 */

/**
 * @swagger
 * components:
 *   schemas:
 *     UserPublic:
 *       type: object
 *       properties:
 *         id:
 *           type: string
 *           format: uuid
 *         email:
 *           type: string
 *           format: email
 *         firstName:
 *           type: string
 *           nullable: true
 *         lastName:
 *           type: string
 *           nullable: true
 *         role:
 *           type: string
 *           enum: [user, admin]
 *         emailVerified:
 *           type: boolean
 *         createdAt:
 *           type: string
 *           format: date-time
 *       required:
 *         - id
 *         - email
 *         - role
 *         - emailVerified
 */
Специфікація API для дій з автомобілем:
/**
 * @swagger
 * tags:
 *   - name: Cars
 *     description: Vehicle management, VIN lookup, ownership history, mileage tampering detection
 */

/**
 * @swagger
 * /api/cars:
 *   post:
 *     summary: Add a new vehicle (for sale or personal use)
 *     description: |
 *       Registers a new car in the system. Automatically creates ownership record.
 *       Validates VIN format and checks for duplicates.
 *       Only authenticated users can add cars.
 *     tags: [Cars]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - vin
 *               - make
 *               - model
 *               - year
 *             properties:
 *               vin:
 *                 type: string
 *                 pattern: ^[A-HJ-NPR-Z0-9]{17}$
 *                 example: WF0AXXTTRALS12345
 *                 description: 17-character VIN (uppercase recommended)
 *               make:
 *                 type: string
 *                 example: Toyota
 *               model:
 *                 type: string
 *                 example: Camry
 *               year:
 *                 type: integer
 *                 minimum: 1886
 *                 maximum: 2026
 *                 example: 2021
 *               color:
 *                 type: string
 *                 example: Pearl White
 *               engineType:
 *                 type: string
 *                 example: 2.5L Hybrid
 *               transmission:
 *                 type: string
 *                 enum: [manual, automatic, cvt, dual-clutch]
 *               fuelType:
 *                 type: string
 *                 enum: [petrol, diesel, hybrid, electric, lpg, hydrogen]
 *               currentMileage:
 *                 type: integer
 *                 minimum: 0
 *                 example: 82340
 *               mileageUnit:
 *                 type: string
 *                 enum: [km, mi]
 *                 default: km
 *               ownershipDocumentUrl:
 *                 type: string
 *                 format: uri
 *                 description: Link to photo/scan of registration certificate
 *               description:
 *                 type: string
 *                 example: One owner, full Toyota service history, winter tires included
 *     responses:
 *       201:
 *         description: Vehicle successfully added
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/CarResponse'
 *       400:
 *         description: Invalid VIN, duplicate VIN, or validation error
 *       401:
 *         description: Unauthorized
 */

/**
 * @swagger
 * /api/cars/vin/{vin}:
 *   get:
 *     summary: Public vehicle lookup by VIN
 *     description: |
 *       **Public endpoint** — no authentication required.
 *       Returns full vehicle profile: specs, current mileage, risk score, ownership history.
 *       Used on landing page and in reports.
 *     tags: [Cars]
 *     parameters:
 *       - in: path
 *         name: vin
 *         required: true
 *         schema:
 *           type: string
 *           pattern: ^[A-HJ-NPR-Z0-9]{17}$
 *         description: 17-character VIN (case-insensitive)
 *         example: WF0AXXTTRALS12345
 *     responses:
 *       200:
 *         description: Vehicle found
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/PublicCarProfile'
 *       404:
 *         description: Vehicle not found
 *       400:
 *         description: Invalid VIN format
 */

/**
 * @swagger
 * /api/cars/{id}:
 *   patch:
 *     summary: Update vehicle information (owner only)
 *     description: |
 *       Only the current owner can update their car.
 *       If new mileage is lower than previous → **mileage tampering detected automatically** → risk score increases.
 *     tags: [Cars]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *           format: uuid
 *         description: Vehicle ID
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               currentMileage:
 *                 type: integer
 *                 minimum: 0
 *                 example: 98765
 *                 description: New odometer reading
 *               description:
 *                 type: string
 *                 example: New summer tires, oil changed
 *               color:
 *                 type: string
 *                 example: Midnight Black
 *               ownershipDocumentUrl:
 *                 type: string
 *                 format: uri
 *             additionalProperties: false
 *     responses:
 *       200:
 *         description: Vehicle updated
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/CarResponse'
 *       400:
 *         description: Mileage rollback detected or invalid data
 *       403:
 *         description: You are not the current owner
 *       404:
 *         description: Vehicle not found
 */

/**
 * @swagger
 * components:
 *   schemas:
 *     Car:
 *       type: object
 *       required:
 *         - id
 *         - vin
 *         - make
 *         - model
 *         - year
 *       properties:
 *         id:
 *           type: string
 *           format: uuid
 *         vin:
 *           type: string
 *           pattern: ^[A-HJ-NPR-Z0-9]{17}$
 *         make:
 *           type: string
 *         model:
 *           type: string
 *         year:
 *           type: integer
 *         color:
 *           type: string
 *           nullable: true
 *         engineType:
 *           type: string
 *           nullable: true
 *         transmission:
 *           type: string
 *           nullable: true
 *         fuelType:
 *           type: string
 *           nullable: true
 *         currentMileage:
 *           type: integer
 *           nullable: true
 *         mileageUnit:
 *           type: string
 *           enum: [km, mi]
 *           default: km
 *         description:
 *           type: string
 *           nullable: true
 *         ownershipDocumentUrl:
 *           type: string
 *           format: uri
 *           nullable: true
 *         riskScore:
 *           type: integer
 *           minimum: 0
 *           maximum: 100
 *           description: 0–30 low, 31–70 medium, 71–100 high risk
 *         riskLevel:
 *           type: string
 *           enum: [low, medium, high]
 *         createdAt:
 *           type: string
 *           format: date-time
 *         updatedAt:
 *           type: string
 *           format: date-time
 *
 *     PublicCarProfile:
 *       type: object
 *       allOf:
 *         - $ref: '#/components/schemas/Car'
 *         - type: object
 *           properties:
 *             carOwners:
 *               type: array
 *               items:
 *                 type: object
 *                 properties:
 *                   isCurrent:
 *                     type: boolean
 *                   startedAt:
 *                     type: string
 *                     format: date-time
 *                   endedAt:
 *                     type: string
 *                     format: date-time
 *                     nullable: true
 *                   startedMileage:
 *                     type: integer
 *                     nullable: true
 *
 *     CarResponse:
 *       type: object
 *       properties:
 *         success:
 *           type: boolean
 *           example: true
 *         data:
 *           $ref: '#/components/schemas/Car'
 *         message:
 *           type: string
 *           example: "Car created successfully"
 */

Специфікація API для подій:
/**
 * @swagger
 * tags:
 *   - name: Events
 *     description: Vehicle history events — accidents, services, inspections, mileage updates, and fraud detection
 */

/**
 * @swagger
 * components:
 *   schemas:
 *     CarEvent:
 *       type: object
 *       properties:
 *         id:
 *           type: string
 *           format: uuid
 *         carId:
 *           type: string
 *           format: uuid
 *         eventType:
 *           type: string
 *           enum: [accident, service, inspection, repair, mileage_update, sale, mileage_tampering, other]
 *         severity:
 *           type: string
 *           enum: [low, medium, high, critical]
 *           nullable: true
 *         description:
 *           type: string
 *           nullable: true
 *         mileage:
 *           type: integer
 *           nullable: true
 *         location:
 *           type: string
 *           nullable: true
 *         cost:
 *           type: string
 *           nullable: true
 *         verifiedByIot:
 *           type: boolean
 *           default: false
 *         documentUrl:
 *           type: string
 *           nullable: true
 *         reportedBy:
 *           type: string
 *           format: uuid
 *           nullable: true
 *         eventDate:
 *           type: string
 *           format: date-time
 *         createdAt:
 *           type: string
 *           format: date-time
 *         updatedAt:
 *           type: string
 *           format: date-time
 *       required:
 *         - id
 *         - carId
 *         - eventType
 *         - eventDate
 *         - createdAt
 *         - updatedAt
 */

/**
 * @swagger
 * /api/events:
 *   post:
 *     summary: Create a new vehicle event
 *     description: |
 *       Add a new event to the vehicle's history.
 *       If mileage is provided and lower than previous records → **mileage tampering detected automatically**.
 *       This will create a `mileage_tampering` event and increase risk score.
 *     tags: [Events]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - carId
 *               - eventType
 *               - eventDate
 *             properties:
 *               carId:
 *                 type: string
 *                 format: uuid
 *                 description: Vehicle ID
 *               eventType:
 *                 type: string
 *                 enum: [accident, service, inspection, repair, mileage_update, sale, other]
 *                 example: accident
 *               severity:
 *                 type: string
 *                 enum: [low, medium, high, critical]
 *                 example: high
 *               description:
 *                 type: string
 *                 example: Rear-end collision at highway, airbag deployed
 *               mileage:
 *                 type: integer
 *                 minimum: 0
 *                 example: 158000
 *                 description: Odometer reading at the time of event (triggers tampering check)
 *               location:
 *                 type: string
 *                 example: Kyiv, Ukraine
 *               cost:
 *                 type: string
 *                 pattern: ^\d+(\.\d{1,2})?$
 *                 example: "2500.00"
 *                 description: Repair cost in USD
 *               documentUrl:
 *                 type: string
 *                 format: uri
 *                 example: https://storage.example.com/accidents/report-123.pdf
 *               eventDate:
 *                 type: string
 *                 format: date-time
 *                 example: "2025-03-15T10:30:00Z"
 *     responses:
 *       201:
 *         description: Event created successfully
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/CarEvent'
 *       400:
 *         description: Mileage tampering detected or invalid data
 *         content:
 *           application/json:
 *             example:
 *               success: false
 *               error: "Mileage tampering detected! Car status updated."
 *       403:
 *         description: Not authorized to add events for this vehicle
 */

/**
 * @swagger
 * /api/events/car/{carId}:
 *   get:
 *     summary: Get all events for a vehicle
 *     description: Returns complete history with filtering support
 *     tags: [Events]
 *     parameters:
 *       - in: path
 *         name: carId
 *         required: true
 *         schema:
 *           type: string
 *           format: uuid
 *         description: Vehicle ID
 *       - in: query
 *         name: eventType
 *         schema:
 *           type: string
 *           enum: [accident, service, mileage_tampering, inspection]
 *         description: Filter by event type
 *       - in: query
 *         name: severity
 *         schema:
 *           type: string
 *           enum: [low, medium, high, critical]
 *       - in: query
 *         name: startDate
 *         schema:
 *           type: string
 *           format: date-time
 *         description: ISO date (e.g., 2024-01-01T00:00:00Z)
 *       - in: query
 *         name: endDate
 *         schema:
 *           type: string
 *           format: date-time
 *     responses:
 *       200:
 *         description: List of events
 *         content:
 *           application/json:
 *             schema:
 *               type: array
 *               items:
 *                 $ref: '#/components/schemas/CarEvent'
 */

/**
 * @swagger
 * /api/events/{eventId}:
 *   put:
 *     summary: Update an existing event
 *     description: Only allowed for events created by the current user
 *     tags: [Events]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: eventId
 *         required: true
 *         schema:
 *           type: string
 *           format: uuid
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               description:
 *                 type: string
 *               cost:
 *                 type: string
 *               documentUrl:
 *                 type: string
 *     responses:
 *       200:
 *         description: Event updated
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/CarEvent'
 *       404:
 *         description: Event not found
 *
 *   delete:
 *     summary: Delete an event
 *     description: Removes event and recalculates vehicle risk score
 *     tags: [Events]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: eventId
 *         required: true
 *         schema:
 *           type: string
 *           format: uuid
 *     responses:
 *       200:
 *         description: Event deleted successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 message:
 *                   type: string
 *                   example: "Event deleted successfully"
 *       404:
 *         description: Event not found
 */

Специфікація API звітів:
/**
 * @swagger
 * tags:
 *   - name: Reports
 *     description: Vehicle history reports with risk analysis and recommendations
 */

/**
 * @swagger
 * /api/reports/{vin}:
 *   get:
 *     summary: Generate vehicle history report
 *     description: |
 *       Generates a detailed vehicle report by VIN.
 *       Currently all report types are **free**.
 *       Includes automatic risk assessment and purchase recommendations.
 *     tags: [Reports]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: vin
 *         required: true
 *         schema:
 *           type: string
 *           pattern: ^[A-HJ-NPR-Z0-9]{17}$
 *         description: 17-character VIN (case-insensitive)
 *       - in: query
 *         name: type
 *         schema:
 *           type: string
 *           enum: [basic, extended, premium]
 *           default: basic
 *         description: |
 *           Report detail level:
 *           - `basic` — summary + critical events
 *           - `extended` — + telemetry + ownership history
 *           - `premium` — full report (currently same as extended)
 *     responses:
 *       200:
 *         description: Vehicle report generated successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 reportType:
 *                   type: string
 *                   enum: [basic, extended, premium]
 *                 generatedAt:
 *                   type: string
 *                   format: date-time
 *                 car:
 *                   $ref: '#/components/schemas/Car'
 *                 events:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/CarEvent'
 *                 owners:
 *                   type: array
 *                   items:
 *                     type: object
 *                 recentTelemetry:
 *                   type: array
 *                   items:
 *                     type: object
 *                 alerts:
 *                   type: array
 *                   items:
 *                     type: object
 *                 recommendations:
 *                   type: array
 *                   items:
 *                     type: object
 *                     properties:
 *                       severity:
 *                         type: string
 *                         enum: [low, medium, high, critical]
 *                       message:
 *                         type: string
 *                     example:
 *                       - severity: critical
 *                         message: "DO NOT BUY: Mileage tampering detected"
 *       404:
 *         description: Vehicle not found
 *       400:
 *         description: Invalid VIN
 */

Специфікація API користувачив:
/**
 * @swagger
 * tags:
 *   - name: Users
 *     description: User profile management, car ownership history, statistics and admin tools
 */

/**
 * @swagger
 * /api/users/profile:
 *   get:
 *     summary: Get current user profile
 *     description: Returns authenticated user's personal information (excluding password)
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: User profile
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/UserProfile'
 *       401:
 *         description: Unauthorized
 *
 *   patch:
 *     summary: Update user profile
 *     description: Partially update first name and/or last name
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               firstName:
 *                 type: string
 *                 maxLength: 100
 *                 example: Andrii
 *               lastName:
 *                 type: string
 *                 maxLength: 100
 *                 example: Salohub
 *             additionalProperties: false
 *     responses:
 *       200:
 *         description: Profile updated successfully
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/UserProfile'
 *       400:
 *         description: Invalid data
 */

/**
 * @swagger
 * /api/users/my-cars:
 *   get:
 *     summary: Get cars currently owned by user
 *     description: Returns list of vehicles where user is the current owner
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Current cars
 *         content:
 *           application/json:
 *             schema:
 *               type: array
 *               items:
 *                 $ref: '#/components/schemas/Car'
 */

/**
 * @swagger
 * /api/users/my-cars/history:
 *   get:
 *     summary: Get complete car ownership history
 *     description: All cars user has ever owned, including past ownerships
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Full ownership history
 *         content:
 *           application/json:
 *             schema:
 *               type: array
 *               items:
 *                 type: object
 *                 allOf:
 *                   - $ref: '#/components/schemas/Car'
 *                   - type: object
 *                     properties:
 *                       ownership:
 *                         type: object
 *                         properties:
 *                           startedAt:
 *                             type: string
 *                             format: date-time
 *                           endedAt:
 *                             type: string
 *                             format: date-time
 *                             nullable: true
 *                           isCurrent:
 *                             type: boolean
 */

/**
 * @swagger
 * /api/users/check-history:
 *   get:
 *     summary: Get user's VIN check history
 *     description: List of all vehicle reports user has requested
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           minimum: 1
 *           maximum: 100
 *           default: 50
 *         description: Number of recent checks to return
 *     responses:
 *       200:
 *         description: Check history
 *         content:
 *           application/json:
 *             schema:
 *               type: array
 *               items:
 *                 $ref: '#/components/schemas/VehicleCheck'
 */

/**
 * @swagger
 * /api/users/stats:
 *   get:
 *     summary: Get user statistics
 *     description: Summary of user's activity and ownership
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: User statistics
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 totalCarsOwned:
 *                   type: integer
 *                   example: 5
 *                 currentCarsOwned:
 *                   type: integer
 *                   example: 2
 *                 totalChecksPerformed:
 *                   type: integer
 *                   example: 47
 *                 memberSince:
 *                   type: string
 *                   format: date-time
 *                   example: "2024-01-15T10:30:00Z"
 */

/**
 * @swagger
 * /api/users/{id}:
 *   get:
 *     summary: Get user by ID (Admin or self)
 *     description: Admin can view any user. Regular user can only view own profile.
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *           format: uuid
 *     responses:
 *       200:
 *         description: User details
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/UserProfile'
 *       403:
 *         description: Access denied
 *       404:
 *         description: User not found
 */

/**
 * @swagger
 * /api/users/account:
 *   delete:
 *     summary: Delete user account
 *     description: Permanently deletes user account. Not allowed if user currently owns any cars.
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Account deleted successfully
 *         content:
 *           application/json:
 *             example:
 *               success: true
 *               data:
 *                 message: "User deleted successfully"
 *       400:
 *         description: Cannot delete — user owns active vehicles
 */

/**
 * @swagger
 * components:
 *   schemas:
 *     UserProfile:
 *       type: object
 *       properties:
 *         id:
 *           type: string
 *           format: uuid
 *         email:
 *           type: string
 *           format: email
 *         firstName:
 *           type: string
 *           nullable: true
 *         lastName:
 *           type: string
 *           nullable: true
 *         role:
 *           type: string
 *           enum: [user, admin]
 *         isBlocked:
 *           type: boolean
 *         emailVerified:
 *           type: boolean
 *         createdAt:
 *           type: string
 *           format: date-time
 *         updatedAt:
 *           type: string
 *           format: date-time
 *       required:
 *         - id
 *         - email
 *         - role
 *         - emailVerified
 *
 *     VehicleCheck:
 *       type: object
 *       properties:
 *         id:
 *           type: string
 *           format: uuid
 *         vin:
 *           type: string
 *         createdAt:
 *           type: string
 *           format: date-time
 *         car:
 *           $ref: '#/components/schemas/Car'
 *           nullable: true
 *         riskScore:
 *           type: integer
 *           nullable: true
 */




     



1



